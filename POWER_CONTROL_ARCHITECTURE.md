# ğŸ“ Diagrama de IntegraciÃ³n - Control de Potencia

## Arquitectura de Software

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         app_main()                              â”‚
â”‚  â€¢ Init NVS â†’ Mutex â†’ GPIO â†’ Sensores â†’ WiFi â†’ MQTT           â”‚
â”‚  â€¢ Carga config guardada                                        â”‚
â”‚  â€¢ Crea todas las tareas FreeRTOS                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                    â–¼                        â–¼          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚task_clim â”‚        â”‚task_mete â”‚          â”‚task_power_ â”‚ â”‚task_ â”‚
    â”‚ate       â”‚        â”‚r         â”‚          â”‚button      â”‚ â”‚ui    â”‚
    â”‚(Pri: 5)  â”‚        â”‚(Pri: 3)  â”‚          â”‚(Pri: 4)    â”‚ â”‚(Pri:2)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                       â”‚            â”‚
         â–¼                    â–¼                       â–¼            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
    â”‚DS18B20   â”‚        â”‚ZMPT/SCT  â”‚          â”‚GPIO 13     â”‚ â”‚LCD   â”‚
    â”‚(3 sens)  â”‚        â”‚(ADC)     â”‚          â”‚(Button)    â”‚ â”‚I2C   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                       â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â–¼
         â”‚        â”‚           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚        â”‚           â”‚              â”‚power_control.c   â”‚
         â”‚        â”‚           â”‚              â”‚                  â”‚
         â”‚        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â€¢ Debounce        â”‚
         â”‚        â”‚                          â”‚â€¢ Toggle estado   â”‚
         â”‚        â”‚                          â”‚â€¢ Update LEDs     â”‚
         â”‚        â”‚                          â”‚â€¢ Save config     â”‚
         â”‚        â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚        â”‚                                  â”‚
         â–¼        â–¼                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  xMutexSys (Thread-Safe)    â”‚       â”‚GPIO 32 & 33 (LEDs)   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚ sys.cfg.system_on   â”‚   â”‚       â”‚â”‚LED_RED (GPIO 32)     â”‚
    â”‚  â”‚ sys.cfg.mode        â”‚   â”‚       â”‚â”‚LED_GREEN (GPIO 33)   â”‚
    â”‚  â”‚ sys.cfg.setpoint    â”‚   â”‚       â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”‚ sys.comp_active     â”‚   â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚ sys.cfg.fan_speed   â”‚   â”‚       â”‚ â–¼         â–¼         â–¼
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   (Actualiza cada ciclo de task_climate)
    â”‚  â”œâ”€ Persistencia en Flash   â”‚       
    â”‚  â””â”€ ProtecciÃ³n contra race  â”‚
    â”‚     conditions              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flujo de DetecciÃ³n del BotÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   task_power_button()   â”‚  (Corre cada 50ms)
â”‚  Muestrea GPIO_15       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ BotÃ³n       â”‚  
        â”‚ presionado? â”‚  
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
             â”‚    â”‚
          SI â”‚    â”‚ NO
             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â–¼                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Debounce â”‚        â”‚ Reset cont â”‚
        â”‚ contador++        â”‚ador        â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚
             â–¼                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚Cont > 2?       â”‚        â”‚
        â”‚(150ms)         â”‚        â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
             â”‚    â”‚               â”‚
          SI â”‚    â”‚ NO            â”‚
             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Obtener Mutex     â”‚    â”‚   â”‚
        â”‚(thread-safe)     â”‚    â”‚   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Invertir estado   â”‚    â”‚   â”‚
        â”‚system_on         â”‚    â”‚   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Guardar en Flash  â”‚    â”‚   â”‚
        â”‚storage_save()    â”‚    â”‚   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Update LEDs       â”‚    â”‚   â”‚
        â”‚power_control_    â”‚    â”‚   â”‚
        â”‚update_leds()     â”‚    â”‚   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Si APAGADO:       â”‚    â”‚   â”‚
        â”‚Detener motores   â”‚    â”‚   â”‚
        â”‚set_relays()      â”‚    â”‚   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Liberar Mutex     â”‚    â”‚   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
             â”‚                   â”‚   â”‚
             â–¼                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
        â”‚Esperar 500ms     â”‚    â”‚   â”‚
        â”‚(debounce release)    â”‚   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
                          â”‚    â”‚   â”‚
                          â””â”€â”€â”€â”€â”´â”€â”€â”€â”˜
                                â”‚
                                â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚ Esperar â”‚
                           â”‚ 50ms    â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Estados del Sistema y LEDs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Estado: SISTEMA APAGADO (OFF)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sys.cfg.system_on = false                                    â”‚
â”‚ Compresor: OFF                                               â”‚
â”‚ Ventilador: OFF                                              â”‚
â”‚ ProtecciÃ³n Hielo: ACTIVA (monitoreo)                         â”‚
â”‚                                                              â”‚
â”‚ LEDS:                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ â”‚ GPIO 32 (ROJO)  â”‚        â”‚ GPIO 33 (VERDE) â”‚             â”‚
â”‚ â”‚ NIVEL: 0 (LOW)  â”‚        â”‚ NIVEL: 1 (HIGH) â”‚             â”‚
â”‚ â”‚ ESTADO: âœ… ON   â”‚        â”‚ ESTADO: â­• OFF  â”‚             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚ ğŸ”´ LED ROJO ENCENDIDO                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Estado: SISTEMA ENCENDIDO (ON)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sys.cfg.system_on = true                                     â”‚
â”‚ Compresor: ACTIVO (cuando T.amb > setpoint + 1)             â”‚
â”‚ Ventilador: A velocidad configurada                         â”‚
â”‚ ProtecciÃ³n Hielo: ACTIVA (monitoreo)                        â”‚
â”‚                                                              â”‚
â”‚ LEDS:                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚ â”‚ GPIO 32 (ROJO)  â”‚        â”‚ GPIO 33 (VERDE) â”‚             â”‚
â”‚ â”‚ NIVEL: 1 (HIGH) â”‚        â”‚ NIVEL: 0 (LOW)  â”‚             â”‚
â”‚ â”‚ ESTADO: â­• OFF  â”‚        â”‚ ESTADO: âœ… ON   â”‚             â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚ ğŸŸ¢ LED VERDE ENCENDIDO                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Prioridades de Tareas FreeRTOS

```
Prioridad   Tarea           Intervalo    FunciÃ³n
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    5       task_climate    1000ms       Control + MQTT + LEDs
    4       task_power_btn    50ms       DetecciÃ³n botÃ³n (debounce)
    3       task_meter       200ms       MediciÃ³n elÃ©ctrica
    2       task_ui         1000ms       Display LCD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Cambios en la Estructura del Proyecto

```
components/
â”œâ”€â”€ ac_meter/              (MediciÃ³n AC)
â”œâ”€â”€ ac_relay/              (Control relÃ©s)
â”œâ”€â”€ ac_storage/            (Persistencia Flash)
â”œâ”€â”€ connectivity/          (WiFi + Portal)
â”œâ”€â”€ ds18b20/               (Sensores temp)
â”œâ”€â”€ i2c_lcd/               (Display LCD)
â”œâ”€â”€ mqtt_connector/        (MQTT WSS)
â””â”€â”€ power_control/         â­ NUEVO
    â”œâ”€â”€ CMakeLists.txt
    â”œâ”€â”€ power_control.c
    â””â”€â”€ include/
        â””â”€â”€ power_control.h
```

## Variables Globales Afectadas

```c
// Ya existentes en main.c
struct SystemState {
    float t_amb, t_out, t_coil;
    float volt, amp, watt;
    sys_config_t cfg;           // â† Incluye system_on
    bool comp_active;           // â† Se pone en false al presionar OFF
    bool freeze_mode;
    bool protection_wait;
} sys;

// Nuevas variables globales
static bool button_last_state;        // Ãšltimo estado del botÃ³n
static uint32_t button_press_debounce; // Contador debounce
```

## Archivo de ConfiguraciÃ³n Guardado (Flash)

```c
typedef struct {
    float setpoint;    // Temperatura objetivo
    int fan_speed;     // Velocidad ventilador
    bool system_on;    // â† GUARDADO EN FLASH AL PRESIONAR BOTÃ“N
    int mode;          // Modo operaciÃ³n
} sys_config_t;
```

El estado `system_on` persiste entre reinicios del ESP32.

---

**Diagrama generado para**: Sistema de Control de Aire v7.1 + Power Control
**Fecha**: 21/01/2026
